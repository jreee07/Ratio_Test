<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>⚡ Ratio Test Calculator ⚡</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen">
  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-2xl">

    <h1 class="text-3xl font-bold text-center mb-6 text-red-600">⚡ Ratio Test Calculator ⚡</h1>

    <!-- Header: Date/Time + Meter Number -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
      <div>
        <label for="dateTime" class="block mb-1 font-medium">Date & Time</label>
        <input id="dateTime" type="text" class="w-full border rounded-lg p-2 text-sm bg-gray-50" readonly />
      </div>
      <div class="md:col-span-2">
        <label for="meterNumber" class="block mb-1 font-medium">Meter Number <span class="text-red-500">*</span></label>
        <input id="meterNumber" type="text" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter meter number" />
      </div>
    </div>

    <!-- Select PT Ratio -->
    <label class="block mb-2 font-medium">Select PT Ratio</label>
    <select id="ptRatio" class="w-full border rounded-lg p-2 mb-4 text-sm">
      <option value="11000/110">11000/110</option>
      <option value="33000/110">33000/110</option>
      <option value="240/240">240/240 LT CT</option>
    </select>

    <!-- Transformer Side -->
    <label class="block mb-2 font-medium">Transformer Current Measuring Side</label>
    <select id="side" class="w-full border rounded-lg p-2 mb-4 text-sm">
      <option value="LT">LT Side</option>
      <option value="HT">HT Side</option>
    </select>

    <!-- Billing OMF -->
    <label class="block mb-2 font-medium">Billing OMF</label>
    <input type="number" id="billingOMF" class="w-full border rounded-lg p-2 mb-4 text-sm" placeholder="Enter Billing OMF">

    <!-- Clamp Currents -->
    <label class="block mb-2 font-medium">Clamp Meter Current</label>
    <div class="grid grid-cols-3 gap-2 mb-4">
      <input type="number" id="clamp1" class="border rounded-lg p-2 text-sm" placeholder="Transformer Current R">
      <input type="number" id="clamp2" class="border rounded-lg p-2 text-sm" placeholder="Transformer Current Y">
      <input type="number" id="clamp3" class="border rounded-lg p-2 text-sm" placeholder="Transformer Current B">
    </div>

    <!-- Energy Meter Currents -->
    <label class="block mb-2 font-medium">Energy Meter Current</label>
    <div class="grid grid-cols-3 gap-2 mb-4">
      <input type="number" id="meter1" class="border rounded-lg p-2 text-sm" placeholder="Meter Current r">
      <input type="number" id="meter2" class="border rounded-lg p-2 text-sm" placeholder="Meter Current y">
      <input type="number" id="meter3" class="border rounded-lg p-2 text-sm" placeholder="Meter Current b">
    </div>

    <!-- Buttons: Calculate + Reset side by side -->
    <div class="flex space-x-2 mb-6">
      <button onclick="calculate()" class="flex-1 bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition">
        Calculate
      </button>

      <button onclick="resetForm()" class="flex-1 bg-gradient-to-r from-red-400 to-red-600 text-white font-semibold py-3 rounded-lg shadow-lg hover:from-red-500 hover:to-red-700 transition">
        Reset
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="mt-10 hidden">
      <div class="border-t pt-6 space-y-4">
        <div class="grid grid-cols-1 gap-4 text-center">
          <div class="bg-gray-100 py-2 rounded-lg shadow">
            <strong>🧲 Average Transformer Current:</strong> <span id="avgClamp"></span> A
          </div>
          <div class="bg-gray-100 py-2 rounded-lg shadow">
            <strong>📟 Average Meter Current:</strong> <span id="avgMeter"></span> A
          </div>
          <div class="bg-blue-100 py-2 rounded-lg shadow">
            <strong>🧮 Calculated Meter Current:</strong> <span id="calcMeter"></span> A
          </div>
          <div class="bg-yellow-200 py-2 rounded-lg shadow text-yellow-900 font-semibold">
            📉 <strong>Difference:</strong> <span id="diff"></span> A
          </div>
        </div>

        <div class="text-center mt-6">
          <div id="commentBox" class="text-white font-bold py-3 px-4 rounded-lg shadow-lg inline-block"></div>
        </div>
      </div>
    </div>

    <!-- Footer Notes -->
    <div class="mt-10 text-center space-y-1">
      <p class="text-gray-600 text-xs">
        Disclaimer: This calculator only verifies billing OMF. To ensure proper metering connection, you need to check vector diagram/phase angles also.
      </p>
      <p class="text-gray-500 text-xs">
        © Energy Audit Cell, HQ, WZPDCL
      </p>
    </div>
  </div>

  <script>
    function formatDateTime(dt = new Date()) {
      const pad = (n) => String(n).padStart(2, '0');
      const dd = pad(dt.getDate());
      const mm = pad(dt.getMonth() + 1);
      const yyyy = dt.getFullYear();
      const hh = pad(dt.getHours());
      const min = pad(dt.getMinutes());
      const ss = pad(dt.getSeconds());
      return `${dd}/${mm}/${yyyy} ${hh}:${min}:${ss}`;
    }

    function setNow() {
      document.getElementById('dateTime').value = formatDateTime(new Date());
    }

    function resetForm() {
      document.getElementById('meterNumber').value = '';
      document.getElementById('ptRatio').selectedIndex = 0;
      document.getElementById('side').selectedIndex = 0;
      document.getElementById('billingOMF').value = '';
      document.getElementById('clamp1').value = '';
      document.getElementById('clamp2').value = '';
      document.getElementById('clamp3').value = '';
      document.getElementById('meter1').value = '';
      document.getElementById('meter2').value = '';
      document.getElementById('meter3').value = '';
      const results = document.getElementById('results');
      results.classList.add('hidden');
      results.querySelector('#avgClamp').textContent = '';
      results.querySelector('#avgMeter').textContent = '';
      results.querySelector('#calcMeter').textContent = '';
      results.querySelector('#diff').textContent = '';
      const commentBox = document.getElementById('commentBox');
      commentBox.textContent = '';
      commentBox.className = 'text-white font-bold py-3 px-4 rounded-lg shadow-lg inline-block';
      setNow();
    }

    function calculate() {
      const meterNumber = document.getElementById("meterNumber").value.trim();
      if (!meterNumber) {
        alert("⚠️ Meter Number is mandatory!");
        return;
      }

      const ptRatio = document.getElementById("ptRatio").value;
      const side = document.getElementById("side").value;
      const billingOMF = parseFloat(document.getElementById("billingOMF").value);

      const clampValues = [
        parseFloat(document.getElementById("clamp1").value) || 0,
        parseFloat(document.getElementById("clamp2").value) || 0,
        parseFloat(document.getElementById("clamp3").value) || 0
      ];

      const meterValues = [
        parseFloat(document.getElementById("meter1").value) || 0,
        parseFloat(document.getElementById("meter2").value) || 0,
        parseFloat(document.getElementById("meter3").value) || 0
      ];

      const avgClamp = average(clampValues);
      const avgMeter = average(meterValues);

      const factors = {
        "11000/110": { LT: 100 / 26.5, HT: 100 },
        "33000/110": { LT: 300 / 79.5, HT: 300 },
        "240/240": { LT: 1, HT: 1 }
      };

      const factor = factors[ptRatio]?.[side];

      if (!factor || isNaN(billingOMF) || billingOMF <= 0) {
        showError("⚠️ Please enter valid inputs for all fields.");
        return;
      }

      const calcMeterCurrent = avgClamp * factor / billingOMF;
      const difference = avgMeter - calcMeterCurrent;
      const absDiff = Math.abs(difference);

      let comment = "";
      let classes = "";

      if (absDiff < 0.05) {
        comment = "আলহামদুলিল্লাহ, রেশিও এবং ওএমএফ ঠিক আছে";
        classes = "bg-gradient-to-r from-green-500 to-green-700";
      } else if (absDiff <= 0.1) {
        comment = "সামান্য একটু পার্থক্য পাওয়া যাচ্ছে, আরেকবার চেক করুন, প্রয়োজনে সিটি/পিটি'র নেমপ্লেট চেক করুন";
        classes = "bg-gradient-to-r from-yellow-400 to-yellow-600 text-yellow-950";
      } else {
        comment = "কাম সারছে, ভালো করে চেক করুন, বিলিং ওএমএফ ঠিক নাই, সিটি/পিটি'র নেমপ্লেট এবং কানেকশন টার্মিনাল এর ছবি নিয়ে রাখুন";
        classes = "bg-gradient-to-r from-red-500 to-red-700";
      }

      document.getElementById("results").classList.remove("hidden");
      document.getElementById("avgClamp").textContent = avgClamp.toFixed(2);
      document.getElementById("avgMeter").textContent = avgMeter.toFixed(2);
      document.getElementById("calcMeter").textContent = calcMeterCurrent.toFixed(2);
      document.getElementById("diff").textContent = difference.toFixed(2);

      const commentBox = document.getElementById("commentBox");
      commentBox.textContent = comment;
      commentBox.className = `font-bold py-3 px-4 rounded-lg shadow-lg inline-block text-white ${classes}`;
    }

    function average(arr) {
      return arr.reduce((sum, val) => sum + val, 0) / arr.length;
    }

    function showError(message) {
      const results = document.getElementById("results");
      results.classList.remove("hidden");
      results.innerHTML = `<p class="text-red-600 font-semibold text-center">${message}</p>`;
    }

    window.addEventListener('load', setNow);
  </script>
</body>
</html>
